@using DataFlow.Common.ExtensionMethods
@model DataFlow.Web.Models.DataMapperViewModel

@foreach (var t in Model.Fields)
{
    <div class="form-group">
        <div class="col-sm-2">
            <label id="@($"lbl{t.Name}")" name="@($"lbl{t.Name}")" for="@($"ddl{t.Name}_SourceColumn")">@($"{t.Name.UpperCaseFirstLetter().UnPascalCase()}")</label>
        </div>
        <div class="col-sm-10 field-block" style="display: @(string.IsNullOrWhiteSpace(t.ChildType) ? "block": "none");">
            <select id="@($"ddl{t.Name}_SourceColumn")" name="@($"ddl{t.Name}_SourceColumn")" class="form-control">
                @foreach (var sourceColumn in Model.SourceColumns)
                {
                    <option value="@sourceColumn.Value">@sourceColumn.Text</option>
                }
            </select>
            <select id="@($"ddl{t.Name}_SourceType")" name="@($"ddl{t.Name}_SourceType")" class="form-control">
                @foreach (var sourceType in Model.DataSources)
                {
                    <option value="@sourceType.Value">@sourceType.Text</option>
                }
            </select>
            <input id="@($"txt{t.Name}_DefaultValue")" name="@($"txt{t.Name}_DefaultValue")" type="text" class="form-control" placeholder="Default Value" />
            <select id="@($"ddl{t.Name}_SourceTable")" name="@($"ddl{t.Name}_SourceTable")" class="form-control">
                @foreach (var sourceTable in Model.SourceTables)
                {
                    <option value="@sourceTable.Value">@sourceTable.Text</option>
                }
            </select>
            <input id="@($"txt{t.Name}_StaticValue")" name="@($"txt{t.Name}_StaticValue")" type="text" class="form-control" placeholder="Static Value" />
            <input id="@($"hf{t.Name}_DataType")" name="@($"hf{t.Name}_DataType")" type="hidden" value="@t.DataType" />
            <input id="@($"hf{t.Name}_ChildType")" name="@($"hf{t.Name}_ChildType")" type="hidden" value="@t.ChildType" />
            <input id="@($"hf{t.Name}_ParentType")" name="@($"hf{t.Name}_ParentType")" type="hidden" value="@t.ParentType" />
        </div>
    </div>
    foreach (var s in t.SubFields)
    {
        <div class="form-group">
            <div>
                <div class="col-sm-2" style="padding-left: 30px;">
                    <label id="@($"lbl{s.Name}_{s.ParentType}")" name="@($"lbl{s.Name}_{s.ParentType}")" for="@($"ddl{s.Name}_SourceColumn_{s.ParentType}")">@($"{s.Name.UpperCaseFirstLetter().UnPascalCase()}")</label>
                </div>
                <div class="col-sm-10 field-block" style="display: @(string.IsNullOrWhiteSpace(s.ChildType) ? "block": "none");">
                    <select id="@($"ddl{s.Name}_SourceColumn_{s.ParentType}")" name="@($"ddl{s.Name}_SourceColumn_{s.ParentType}")" class="form-control">
                        @foreach (var sourceColumn in Model.SourceColumns)
                        {
                            <option value="@sourceColumn.Value">@sourceColumn.Text</option>
                        }
                    </select>
                    <select id="@($"ddl{s.Name}_SourceType_{s.ParentType}")" name="@($"ddl{s.Name}_SourceType_{s.ParentType}")" class="form-control">
                        @foreach (var sourceType in Model.DataSources)
                        {
                            <option value="@sourceType.Value">@sourceType.Text</option>
                        }
                    </select>
                    <input id="@($"txt{s.Name}_DefaultValue_{s.ParentType}")" name="@($"txt{s.Name}_DefaultValue_{s.ParentType}")" type="text" class="form-control" placeholder="Default Value" />
                    <select id="@($"ddl{s.Name}_SourceTable_{s.ParentType}")" name="@($"ddl{s.Name}_SourceTable_{s.ParentType}")" class="form-control">
                        @foreach (var sourceTable in Model.SourceTables)
                        {
                            <option value="@sourceTable.Value">@sourceTable.Text</option>
                        }
                    </select>
                    <input id="@($"txt{s.Name}_StaticValue_{s.ParentType}")" name="@($"txt{s.Name}_StaticValue_{s.ParentType}")" type="text" class="form-control" placeholder="Static Value" />
                    <input id="@($"hf{s.Name}_DataType_{s.ParentType}")" name="@($"hf{s.Name}_DataType_{s.ParentType}")" type="hidden" value="@s.DataType" />
                    <input id="@($"hf{s.Name}_ChildType_{s.ParentType}")" name="@($"hf{s.Name}_ChildType_{s.ParentType}")" type="hidden" value="@s.ChildType" />
                    <input id="@($"hf{s.Name}_ParentType_{s.ParentType}")" name="@($"hf{s.Name}_ParentType_{s.ParentType}")" type="hidden" value="@s.ParentType" />
                </div>
            </div>
        </div>
    }
}
@Html.Hidden("FieldNames", string.Join(";", Model.GetAllFieldNames()))
<script type="text/javascript">
    $(".field-block").change(function (e) {
        var frmData = $("#frmDataMapper").serialize();
        
        $.ajax({
            type: "POST",
            url: "/DataMapper/UpdateJsonMap?triggeredBy=" + e.target.id,
            data: frmData,
            dataType: "json",
            success: function (data) {
                $("#JsonMap").val(data);
            },
            fail: function (data) {
                alert("Error: " + data);
            }
        });
    });
</script>
 