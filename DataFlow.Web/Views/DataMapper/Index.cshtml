@model DataFlow.Web.Models.DataMapperViewModel

@{
    ViewBag.Title = "Advanced Data Mapper";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>@ViewBag.Title</h2>

<style type="text/css">
    .field-block input[type],
    .field-block textarea,
    .field-block select {
        display: block;
        margin-bottom: 5px;
    }
</style>

@using (Html.BeginForm("Index", "DataMapper", FormMethod.Post, new { @class = "form-horizontal", id="frmDataMapper" }))
{
    @Html.AntiForgeryToken()
    @Html.ValidationSummary(true, "", new { @class = "text-danger" })
    <div class="form-group">
        <div class="col-sm-2">
            @Html.LabelFor(m => m.MapName, new { @class = "control-label" })
        </div>
        <div class="col-sm-10">
            @Html.TextBoxFor(m => m.MapName, new { @class = "form-control", type = "text", placeholder = "Map Name" })
            @Html.ValidationMessageFor(m => m.MapName)
        </div>
    </div>
    <div class="form-group">
        <div class="col-sm-2">
            @Html.LabelFor(m => m.MapToEntity, new { @class = "control-label" })
        </div>
        <div class="col-sm-10">
            @Html.DropDownListFor(m => m.MapToEntity, Model.Entities, new { @class = "form-control" })
            @Html.ValidationMessageFor(m => m.MapToEntity)
        </div>
    </div>
    foreach (string t in Model.Fields)
    {
        <div class="form-group">
            <div class="col-sm-2">
                @*@Html.LabelFor(m=>m.Fields[i], new { @class = "control-label" })*@
                <label id="@($"lbl{t}")" name="@($"lbl{t}")" for="@($"txt{t}_SourceColumn")">@($"{t}")</label>
            </div>
            <div class="col-sm-10 field-block">
                @*@Html.TextBoxFor(m => m.Fields[i], new { @class = "form-control", type = "text" })*@
                <input id="@($"txt{t}_SourceColumn")" name="@($"txt{t}_SourceColumn")" type="text" class="form-control" />
                <input id="@($"txt{t}_SourceType")" name="@($"txt{t}_SourceType")" type="text" class="form-control" />
                <input id="@($"txt{t}_DefaultValue")" name="@($"txt{t}_DefaultValue")" type="text" class="form-control" />
                <input id="@($"txt{t}_SourceTable")" name="@($"txt{t}_SourceTable")" type="text" class="form-control" />
                <input id="@($"txt{t}_StaticValue")" name="@($"txt{t}_StaticValue")" type="text" class="form-control" />
            </div>
        </div>
    }
    <div class="form-group">
        <div class="col-sm-2">
            @Html.LabelFor(m => m.JsonMap, new { @class = "control-label" })
        </div>
        <div class="col-sm-10">
            @Html.TextAreaFor(m => m.JsonMap, new { @class = "form-control", type = "text", placeholder = "Map JSON", style = "height:500px;" })
            @Html.ValidationMessageFor(m => m.JsonMap)
        </div>
    </div>
    @Html.Hidden("FieldNames", string.Join(";",Model.Fields))
}
@section scripts{
    <script type="text/javascript">
        $(".field-block").change(function () {
            var frmData = $("#frmDataMapper").serialize();
            var jsonMap = $("#JsonMap");

            $.ajax({
                type: "POST",
                url: '@Url.Action("UpdateJsonMap", "DataMapper")',
                data: frmData,
                dataType: "json",
                success: function (data) {
                    $("#JsonMap").val(data);
                },
                fail: function (data) {
                    alert("Unable to connect to the API.");
                }
            });
        });
    </script>
}